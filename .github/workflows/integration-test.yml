# Copyright (c) 2020-2021 Afterpay Corporate Services Pty Ltd
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# See https://help.github.com/en/actions/configuring-and-managing-workflows
# See https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions

name: Integration Test

on:
  push:
    branches:
      - master
      - 'release/**'
    paths-ignore:
      - 'README.md'
      - 'sample.env.php'
      - '.gitignore'
  pull_request:
    branches:
      - master
      - 'release/**'
    paths-ignore:
      - 'README.md'
      - 'sample.env.php'
      - '.gitignore'

# Note: For information on the `ubuntu-latest` base image, see:
# https://github.com/actions/virtual-environments/blob/master/images/linux/Ubuntu1804-README.md

jobs:
  oceania:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        country-code: [ 'AU', 'NZ' ]
        include:
          - country-code: 'AU'
            mid: 'AU_SBOX_MID_1'
            skey: 'AU_SBOX_SKEY_1'
            email: 'AU_SBOX_CONSUMER_EMAIL_1'
            pword: 'AU_SBOX_CONSUMER_PASSWORD_1'

          - country-code: 'NZ'
            mid: 'NZ_SBOX_MID_1'
            skey: 'NZ_SBOX_SKEY_1'
            email: 'NZ_SBOX_CONSUMER_EMAIL_1'
            pword: 'NZ_SBOX_CONSUMER_PASSWORD_1'
      fail-fast: false
      max-parallel: 1

    name: ${{ matrix.country-code }} Sandbox

    steps:
      - uses: actions/checkout@v2

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest
      
      - name: Start MySQL service
        run: sudo systemctl start mysql.service

      - name: Create a database for PersistentStorage
        run: mysql -u root -proot -e "CREATE DATABASE sdk_php;"

      - name: Run integration test suite
        env:
          MERCHANT_ID: ${{ secrets[matrix.mid] }}
          SECRET_KEY: ${{ secrets[matrix.skey] }}
          COUNTRY_CODE: ${{ matrix.country-code }}
          DB_API: mysqli
          DB_DATABASE: sdk_php
          DB_USER: root
          DB_PASS: root
          TEST_CONSUMER_EMAIL: ${{ secrets[matrix.email] }}
          TEST_CONSUMER_PASSWORD: ${{ secrets[matrix.pword] }}
        run: composer test-integration
  north-america:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        country-code: [ 'CA', 'US' ]
        include:
          - country-code: 'CA'
            mid: 'CA_SBOX_MID_1'
            skey: 'CA_SBOX_SKEY_1'
            email: 'CA_SBOX_CONSUMER_EMAIL_1'
            pword: 'CA_SBOX_CONSUMER_PASSWORD_1'

          - country-code: 'US'
            mid: 'US_SBOX_MID_1'
            skey: 'US_SBOX_SKEY_1'
            email: 'US_SBOX_CONSUMER_EMAIL_1'
            pword: 'US_SBOX_CONSUMER_PASSWORD_1'
      fail-fast: false
      max-parallel: 1

    name: ${{ matrix.country-code }} Sandbox

    steps:
      - uses: actions/checkout@v2

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest
      
      - name: Start MySQL service
        run: sudo systemctl start mysql.service

      - name: Create a database for PersistentStorage
        run: mysql -u root -proot -e "CREATE DATABASE sdk_php;"

      - name: Run integration test suite
        env:
          MERCHANT_ID: ${{ secrets[matrix.mid] }}
          SECRET_KEY: ${{ secrets[matrix.skey] }}
          COUNTRY_CODE: ${{ matrix.country-code }}
          DB_API: mysqli
          DB_DATABASE: sdk_php
          DB_USER: root
          DB_PASS: root
          TEST_CONSUMER_EMAIL: ${{ secrets[matrix.email] }}
          TEST_CONSUMER_PASSWORD: ${{ secrets[matrix.pword] }}
        run: composer test-integration
  europe:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false

    name: UK Sandbox

    steps:
      - uses: actions/checkout@v2

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest
      
      - name: Start MySQL service
        run: sudo systemctl start mysql.service

      - name: Create a database for PersistentStorage
        run: mysql -u root -proot -e "CREATE DATABASE sdk_php;"

      - name: Run integration test suite
        env:
          MERCHANT_ID: ${{ secrets.UK_SBOX_MID_1 }}
          SECRET_KEY: ${{ secrets.UK_SBOX_SKEY_1 }}
          COUNTRY_CODE: GB
          DB_API: mysqli
          DB_DATABASE: sdk_php
          DB_USER: root
          DB_PASS: root
          TEST_CONSUMER_EMAIL: ${{ secrets.UK_SBOX_CONSUMER_EMAIL_1 }}
          TEST_CONSUMER_PASSWORD: ${{ secrets.UK_SBOX_CONSUMER_PASSWORD_1 }}
        run: composer test-integration
  #southern-europe:
